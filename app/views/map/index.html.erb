<div class="top_map_buttom_block" style="padding:50px 0 0 0;">
	<script src="https://maps.googleapis.com/maps/api/js?&sensor=false&libraries=places"></script>
	<div id="map-canvas" style="width:100%;height:100%;">
	</div>
	<div id="map_detail" style="width:100%;height:100%;display:none;">
		<input type="hidden" id="mapid" value="" />
		<div style="margin:60px 0 0 0;padding:0 5px 5px 5px;">
			<h2 id="atm_title">タイトル</h2>
			<table style="width:100%"><tbody>
				<tr>
					<td style="text-align:center;width:33%;">
						<img src="/assets/up.png" width="30" heigth="30"/><br/>
						使った
					</td>
					<td style="text-align:center;width:33%;">
						<img src="/assets/clip.png" width="30" heigth="30" /><br/>
						クリップ
					</td>
					<td style="text-align:center;width:33%;">
						<img src="/assets/sa.png" width="30" heigth="30" /><br/>
						検索
					</td>
				</tr>
				<tr>
					<td style="text-align:center;">
						<span id="use_count"></span>
					</td>
					<td style="text-align:center;">
						<span id="clip_count"></span>
					</td>
					<td style="text-align:center;">
						<span id="search_count"></span>
					</td>
				</tr>
			</tbody></table>
			<br/><br/>
			<table><tbody><tr>
				<td style="text-align:center;">
					<img src="/assets/up.png" width="30" heigth="30" onclick="use_add()"/><br/>
					使った
				</td>
				<td style="text-align:center;">
					<img src="/assets/clip.png" width="30" heigth="30" /><br/>
					クリップ
				</td>
			</tr></tbody></table>
			ユーザから参照された回数：<br/>
			週次ヒートマップ<br/><br/>
			<b>メモ</b><br>
			<p id="atm_memo">メモ読み込み中・・・</p><br/>
			<b>コメント</b><br>
			<p id="atm_comm">コメント読み込み中・・・</p>
			<button type="button" class="btn btn-primary" onclick="view_detail('','','','','');">閉じる</button>
		</div>
	</div>
</div>
<div id="map_footer">
	<b>ATMを登録する</b><br/>
	<input type="hidden" name="kind" id="kind" value="0" />
	<input type="hidden" name="lat" id="lat" value=""/>
  	<input type="hidden" name="lgn" id="lgn" value=""/>
		<table><tbody><tr>
			<td><button  type="button" class="btn btn-primary" onclick="$('#bankkind').click();">①配置</button></td>
			<td style="padding:0 0 0 10px;"><button  type="button" class="btn btn-success" onclick="regist_map();">②登録</button></td>
		</tr></tbody></table>
		<a href="#kind_lanche" rel="leanModal_kindlancher" id="bankkind" style="display:none;">リンク</a>
</div>
<div id="kind_lanche" style="border-radius:5px">
  <div class="kind_close" style="width:40px; float:right;">閉じる</div><br clear="both"/>
  <div>
  	<b>銀行名（頭の位置文字で絞り込みます）</b><br/>
	<a href="javascript:void(0)" onclick="where(1)" style="font-size:20px;">あ</a>　
	<a href="javascript:void(0)" onclick="where(2)" style="font-size:20px;">か</a>　
	<a href="javascript:void(0)" onclick="where(3)" style="font-size:20px;">さ</a>　
	<a href="javascript:void(0)" onclick="where(4)" style="font-size:20px;">た</a>　
	<a href="javascript:void(0)" onclick="where(5)" style="font-size:20px;">な</a>　
	<a href="javascript:void(0)" onclick="where(6)" style="font-size:20px;">は</a>　
	<a href="javascript:void(0)" onclick="where(7)" style="font-size:20px;">ま</a>　
	<a href="javascript:void(0)" onclick="where(8)" style="font-size:20px;">や</a>　
	<a href="javascript:void(0)" onclick="where(9)" style="font-size:20px;">ら</a>　
	<a href="javascript:void(0)" onclick="where(10)" style="font-size:20px;">わ</a>

  	<div id="name_sort">
		<img src="/assets/1.png" onclick="select(1)"/>
		<img src="/assets/2.png" onclick="select(2)"/>
		<img src="/assets/3.png" onclick="select(3)"/>
		<img src="/assets/4.png" onclick="select(4)"/>
		<div id = "where_a" style="display:none;">
			<table><tbody><tr>
				<td valign="top">
					<a href="javascript:void(0)" onclick="select(118)">愛知銀行（愛知県）</a><br/>
					<a href="javascript:void(0)" onclick="select(22)">あおぞら銀行（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(6)">あおぞら信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(37)">青森銀行（青森県）</a><br/>
					<a href="javascript:void(0)" onclick="select(42)">秋田銀行（秋田県）</a><br/>
					<a href="javascript:void(0)" onclick="select(49)">足利銀行（栃木県）</a><br/>
					<a href="javascript:void(0)" onclick="select(83)">阿波銀行（徳島県）</a><br/>
					<a href="javascript:void(0)" onclick="select(23)">イオン銀行（東京都）</a><br/>
				</td><td valign="top">
					<a href="javascript:void(0)" onclick="select(74)">池田泉州銀行（大阪府）</a><br/>
					<a href="javascript:void(0)" onclick="select(39)">岩手銀行（岩手県）</a><br/>
					<a href="javascript:void(0)" onclick="select(85)">伊予銀行（愛媛県）</a><br/>
					<a href="javascript:void(0)" onclick="select(131)">愛媛銀行（愛媛県）</a><br/>
					<a href="javascript:void(0)" onclick="select(24)">SBJ銀行（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(13)">SMBC信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(95)">大分銀行（大分県）</a><br/>
					<a href="javascript:void(0)" onclick="select(64)">大垣共立銀行（岐阜県）</a><br/>
					<a href="javascript:void(0)" onclick="select(99)">沖縄銀行（沖縄県）</a><br/>
					<a href="javascript:void(0)" onclick="select(140)">沖縄海邦銀行（沖縄県</a><br/>
					<a href="javascript:void(0)" onclick="select(7)">オリックス銀行</a>
				</td>
			</tr></tbody></table>
		</div>
		<div id = "where_ka" style="display:none;">
			<table><tbody><tr>
				<td valign="top">
					<a href="javascript:void(0)" onclick="select(130)">香川銀行（香川県）</a><br/>
					<a href="javascript:void(0)" onclick="select(97)">鹿児島銀行（鹿児島県）</a><br/>
					<a href="javascript:void(0)" onclick="select(112)">神奈川銀行（神奈川銀行）</a><br/>
					<a href="javascript:void(0)" onclick="select(122)">関西アーバン銀行（大阪府）</a><br/>
					<a href="javascript:void(0)" onclick="select(90)">北九州銀行（福岡県）</a><br/>
					<a href="javascript:void(0)" onclick="select(62)">北國銀行（石川県）</a><br/>
					<a href="javascript:void(0)" onclick="select(102)">北日本銀行（岩手県）</a><br/>
				</td><td valign="top">
					<a href="javascript:void(0)" onclick="select(101)">きらやか銀行（山形県）</a><br/>
					<a href="javascript:void(0)" onclick="select(76)">紀陽銀行（和歌山県）</a><br/>
					<a href="javascript:void(0)" onclick="select(72)">京都銀行（京都府）</a><br/>
					<a href="javascript:void(0)" onclick="select(73)">近畿大阪銀行（大阪府）</a><br/>
					<a href="javascript:void(0)" onclick="select(136)">熊本銀行（熊本県）</a><br/>
					<a href="javascript:void(0)" onclick="select(50)">群馬銀行（群馬県）</a><br/>
					<a href="javascript:void(0)" onclick="select(108)">京葉銀行（千葉県）</a><br/>
					<a href="javascript:void(0)" onclick="select(132)">高知銀行（高知県）</a>
				</td>
			</tr></tbody></table>
		</div>
		<div id = "where_sa" style="display:none;">
			<table><tbody><tr>
				<td valign="top">
					<a href="javascript:void(0)" onclick="select(91)">佐賀銀行（佐賀県）</a><br/>
					<a href="javascript:void(0)" onclick="select(134)">佐賀共栄銀行（佐賀県）</a><br/>
					<a href="javascript:void(0)" onclick="select(79)">山陰合同銀行（島根県）</a><br/>
					<a href="javascript:void(0)" onclick="select(71)">滋賀銀行（滋賀県）</a><br/>
					<a href="javascript:void(0)" onclick="select(8)">資産管理サービス信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(66)">静岡銀行（静岡県）</a><br/>
					<a href="javascript:void(0)" onclick="select(117)">静岡中央銀行（静岡県）</a><br/>
					<a href="javascript:void(0)" onclick="select(25)">シティバンク銀行（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(41)">七十七銀行（宮城県）</a><br/>
					<a href="javascript:void(0)" onclick="select(26)">じぶん銀行（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(125)">島根銀行（島根県）</a><br/>
					<a href="javascript:void(0)" onclick="select(68)">清水銀行（静岡県）</a><br/>
					<a href="javascript:void(0)" onclick="select(30)">住信SBIネット銀行株（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(27)">ジャパンネット銀行（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(92)">十八銀行（佐賀県）</a><br/>
				</td><td valign="top">
					<a href="javascript:void(0)" onclick="select(65)">十六銀行（岐阜県）</a><br/>
					<a href="javascript:void(0)" onclick="select(44)">荘内銀行（山形県）</a><br/>
					<a href="javascript:void(0)" onclick="select(47)">常陽銀行（茨城県）</a><br/>
					<a href="javascript:void(0)" onclick="select(28)">新銀行東京（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(9)">しんきん信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(29)">新生銀行（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(10)">新生信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(93)">親和銀行（長崎県）</a><br/>
					<a href="javascript:void(0)" onclick="select(11)">ステート・ストリート信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(67)">スルガ銀行（静岡県）</a><br/>
					<a href="javascript:void(0)" onclick="select(31)">整理回収機構</a><br/>
					<a href="javascript:void(0)" onclick="select(4)">セブン銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(103)">仙台銀行（宮城県）</a><br/>
					<a href="javascript:void(0)" onclick="select(32)">ソニー銀行</a>
				</td>
			</tr></tbody></table>
		</div>
		<div id = "where_ta" style="display:none;">
			<table><tbody><tr>
				<td valign="top">
					<a href="javascript:void(0)" onclick="select(123)">大正銀行（大阪府）</a><br/>
					<a href="javascript:void(0)" onclick="select(113)">大光銀行（新潟県）</a><br/>
					<a href="javascript:void(0)" onclick="select(105)">大東銀行（福島県）</a><br/>
					<a href="javascript:void(0)" onclick="select(121)">第三銀行（三重県）</a><br/>
					<a href="javascript:void(0)" onclick="select(56)">第四銀行（新潟県）</a><br/>
					<a href="javascript:void(0)" onclick="select(77)">但馬銀行（兵庫県）</a><br/>
					<a href="javascript:void(0)" onclick="select(52)">千葉銀行（千葉県）</a><br/>
					<a href="javascript:void(0)" onclick="select(53)">千葉興業銀行（千葉県）</a><br/>
					<a href="javascript:void(0)" onclick="select(48)">筑波銀行（茨城県）</a><br/>
					<a href="javascript:void(0)" onclick="select(88)">筑邦銀行（福岡県）</a><br/>
					<a href="javascript:void(0)" onclick="select(120)">中京銀行（愛知県）</a><br/>
					<a href="javascript:void(0)" onclick="select(80)">中国銀行（岡山県）</a><br/>
				</td><td valign="top">
					<a href="javascript:void(0)" onclick="select(110)">東京スター銀行（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(54)">東京都民銀行（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(46)">東邦銀行（福島県）</a><br/>
					<a href="javascript:void(0)" onclick="select(40)">東北銀行（岩手県）</a><br/>
					<a href="javascript:void(0)" onclick="select(129)">徳島銀行（徳島県）</a><br/>
					<a href="javascript:void(0)" onclick="select(107)">栃木銀行（栃木県）</a><br/>
					<a href="javascript:void(0)" onclick="select(78)">鳥取銀行（鳥取県）</a><br/>
					<a href="javascript:void(0)" onclick="select(126)">トマト銀行（岡山県）</a><br/>
					<a href="javascript:void(0)" onclick="select(61)">富山銀行（富山県）</a><br/>
					<a href="javascript:void(0)" onclick="select(115)">富山第一銀行（富山県）</a><br/>
					<a href="javascript:void(0)" onclick="select(106)">東和銀行（群馬県）</a>
				</td>
			</tr></tbody></table>
		</div>
		<div id = "where_na" style="display:none;">
			<table><tbody><tr>
				<td valign="top">
					<a href="javascript:void(0)" onclick="select(114)">長野銀行（長野県）</a><br/>
					<a href="javascript:void(0)" onclick="select(135)">長崎銀行（長崎県）</a><br/>
					<a href="javascript:void(0)" onclick="select(119)">名古屋銀行（愛知県）</a><br/>
					<a href="javascript:void(0)" onclick="select(128)">西京銀行（山口県）</a><br/>
					<a href="javascript:void(0)" onclick="select(75)">南都銀行（奈良県）</a><br/>
					<a href="javascript:void(0)" onclick="select(89)">西日本シティ銀行（福岡県）</a><br/>
				</td><td valign="top">
					<a href="javascript:void(0)" onclick="select(14)">日証金信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(15)">日本トラスティ・サービス信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(16)">日本マスタートラスト信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(17)">ニューヨークメロン信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(19)">野村信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(18)">農中信託銀行</a>
				</td>
			</tr></tbody></table>
		</div>
		<div id = "where_ha" style="display:none;">
			<table><tbody><tr>
				<td valign="top">
					<a href="javascript:void(0)" onclick="select(59)">八十二銀行（長野県）</a><br/>
					<a href="javascript:void(0)" onclick="select(109)">東日本銀行（東京都）</a><br/>
					<a href="javascript:void(0)" onclick="select(94)">肥後銀行（長崎県）</a><br/>
					<a href="javascript:void(0)" onclick="select(70)">百五銀行（三重県）</a><br/>
					<a href="javascript:void(0)" onclick="select(84)">百十四銀行（香川県）</a><br/>
					<a href="javascript:void(0)" onclick="select(81)">広島銀行（広島県）</a><br/>
					<a href="javascript:void(0)" onclick="select(63)">福井銀行（福井県）</a><br/>
					<a href="javascript:void(0)" onclick="select(87)">福岡銀行（福岡県）</a><br/>
				</td><td valign="top">
					<a href="javascript:void(0)" onclick="select(133)">福岡中央銀行（福岡県）</a><br/>
					<a href="javascript:void(0)" onclick="select(104)">福島銀行（福島県）</a><br/>
					<a href="javascript:void(0)" onclick="select(116)">福邦銀行（福井県）</a><br/>
					<a href="javascript:void(0)" onclick="select(137)">豊和銀行（大分県）</a><br/>
					<a href="javascript:void(0)" onclick="select(57)">北越銀行（新潟県）</a><br/>
					<a href="javascript:void(0)" onclick="select(36)">北海道銀行（北海道）</a><br/>
					<a href="javascript:void(0)" onclick="select(43)">北都銀行（秋田県）</a><br/>
					<a href="javascript:void(0)" onclick="select(60)">北陸銀行（富山県）</a><br/>
					<a href="javascript:void(0)" onclick="select(100)">北洋銀行（北海道）</a>
				</td>
			</tr></tbody></table>
		</div>
		<div id = "where_ma" style="display:none;">
			<table><tbody><tr>
				<td valign="top">
					<a href="javascript:void(0)" onclick="select(69)">三重銀行（三重県）</a><br/>
					<a href="javascript:void(0)" onclick="select(20)">みずほ信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(3)">三井住友銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(12)">三井住友信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(38)">みちのく銀行（青森県）</a><br/>
					<a href="javascript:void(0)" onclick="select(2)">三菱東京UFJ銀行</a><br/>
				</td><td valign="top">
					<a href="javascript:void(0)" onclick="select(21)">三菱UFJ信託銀行</a><br/>
					<a href="javascript:void(0)" onclick="select(124)">みなと銀行（兵庫県）</a><br/>
					<a href="javascript:void(0)" onclick="select(139)">南日本銀行（鹿児島県）</a><br/>
					<a href="javascript:void(0)" onclick="select(96)">宮崎銀行（宮崎県）</a><br/>
					<a href="javascript:void(0)" onclick="select(138)">宮崎太陽銀行（宮崎県）</a><br/>
					<a href="javascript:void(0)" onclick="select(51)">武蔵野銀行（埼玉県）</a><br/>
					<a href="javascript:void(0)" onclick="select(127)">もみじ銀行（広島県）</a>
				</td>
			</tr></tbody></table>
		</div>
		<div id = "where_ya" style="display:none;">
			<a href="javascript:void(0)" onclick="select(111)">八千代銀行（東京都）</a><br/>
			<a href="javascript:void(0)" onclick="select(45)">山形銀行（山形県）</a><br/>
			<a href="javascript:void(0)" onclick="select(82)">山口銀行（山口県）</a><br/>
			<a href="javascript:void(0)" onclick="select(33)">大和ネクスト銀行</a><br/>
			<a href="javascript:void(0)" onclick="select(58)">山梨中央銀行（山梨県）</a><br/>
			<a href="javascript:void(0)" onclick="select(35)">ゆうちょ銀行</a><br/>
			<a href="javascript:void(0)" onclick="select(55)">横浜銀行（神奈川県）</a>
		</div>
		<div id = "where_ra" style="display:none;">
			<a href="javascript:void(0)" onclick="select(34)">楽天銀行</a><br/>
			<a href="javascript:void(0)" onclick="select(5)">りそな銀行</a><br/>
			<a href="javascript:void(0)" onclick="select(98)">琉球銀行（沖縄県）</a>
		</div>
  	</div>
  </div>
</div>
<audio id="sound-file" preload="auto">
	<source src="/assets/change.mp3" type="audio/mp3">
</audio>

<script type="text/javascript">
$('#layout_head').css({position: "absolute",  top: "0", left: "0", zIndex: "1"});
var before_title ="";
//キャンパスの要素を取得する
var canvas = document.getElementById( "map-canvas" );
var markers = new Array();
var crossSize = 19;
//中心の位置座標を指定する
var map;
var tmpmarker;
var selfmarker;
var rendererOptions = {
	draggable: true,
	preserveViewport:false
};
var directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
directionsDisplay.setOptions( {
	suppressMarkers: true
});
var directionsService = new google.maps.DirectionsService();
var myInfoWindow;
// //地図のオプションを設定する
// var mapOptions = {
// 	zoom: 15 ,				//ズーム値
// 	center: latlng,
// 	scrollwheel: false,
// 	mapTypeControlOptions: { mapTypeIds: ['sample', google.maps.MapTypeId.ROADMAP] }
// };

// 	map = new google.maps.Map( canvas , mapOptions );
// 	var latlng = map.getCenter();
// 	var lat = latlng.lat();
// 	var lng = latlng.lng();
// 	$("#lat").val(lat);
// 	$("#lgn").val(lng);
<% if @input_lat.blank? %>
	codeAddress('<%= @keyword %>');
<% else %>
	codeAddress_log(<%= @input_lat %>,<%= @input_lgn %>);
<% end %>
createCenterMaker();

/**************************************************************************/
	function CrossControl( controlDiv, map )
	/*
	* センターマーカーオブジェクト
	***************************************************************************/
	{

		var mapDiv = map.getDiv();

		// 縦のライン
		var controlCrossV = document.createElement('DIV');
		controlCrossV.style.position = 'absolute'
		controlCrossV.style.borderStyle = 'none none none solid';
		controlCrossV.style.borderWidth = '1px';
		controlCrossV.style.borderColor = 'red';
		controlCrossV.style.height = crossSize + 'px';
		controlCrossV.style.marginTop   = (( mapDiv.offsetHeight - crossSize + 1) / 2) + 'px';
		controlDiv.appendChild( controlCrossV );

		// 横のライン
		var controlCrossH = document.createElement('DIV');
		controlCrossH.style.position = 'absolute'
		controlCrossH.style.borderStyle = 'solid none none none';
		controlCrossH.style.borderWidth = '1px';
		controlCrossH.style.borderColor = 'red';
		controlCrossH.style.width = crossSize + 'px';
		controlCrossH.style.marginTop =  mapDiv.offsetHeight / 2 + 'px';
		controlCrossH.style.marginLeft = (( crossSize - 1 ) / -2) + 'px';
		controlDiv.appendChild( controlCrossH );
	}

	/**************************************************************************/
	function createCenterMaker()
	/*
	* センターマーカー作成
	***************************************************************************/
	{
		var CrossControlDiv = document.createElement('DIV');
		var crossControl = new CrossControl( CrossControlDiv, map );

		CrossControlDiv.index = 1;
		map.controls[google.maps.ControlPosition.TOP].push( CrossControlDiv );
	}

function codeAddress(address) {
	if(address == '') {
		address = '皇居';
	}
  var geocoder = new google.maps.Geocoder();

  var mapOptions = {
    zoom: 18,
    scrollwheel: false,
     mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
  geocoder.geocode( { 'address': address}, function(results, status) {

    // ジオコーディングが成功した場合
    if (status == google.maps.GeocoderStatus.OK) {
	    map.setCenter(results[0].geometry.location);
		createCenterMaker();

		dispLatLng();

		google.maps.event.addListener(map, 'dragend', function() {
			dispLatLng();
		});

    } else {
    }
  });
}
function codeAddress_log(lat, lgn) {
  var geocoder = new google.maps.Geocoder();
  var myLatlng = new google.maps.LatLng(lat, lgn);
  var mapOptions = {
    zoom: 18,
    scrollwheel: false,
    center: myLatlng,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
  geocoder.geocode({latLng: myLatlng}, function(results, status) {

  	// self location map
  	if (selfmarker != null ) {
		selfmarker.setMap(null);
	}

	selfmarker = new google.maps.Marker({
		position: new google.maps.LatLng(
			lat,
			lgn
		),
		animation: google.maps.Animation.DROP,
		draggable: true,
		map: map,
		icon: "/assets/self.png"
	});
	$("#self_lat").val(lat);
	$("#self_lgn").val(lgn);

	// self marker drag event
	google.maps.event.addListener( selfmarker, 'dragend', function(ev){
		$("#self_lat").val(ev.latLng.lat());
		$("#self_lgn").val(ev.latLng.lng());
	});

    if (status == google.maps.GeocoderStatus.OK) {
	    map.setCenter(results[0].geometry.location);
		createCenterMaker();
		dispLatLng();

		google.maps.event.addListener(map, 'dragend', function() {
			dispLatLng();
		});
    } else {
    }
  });
}
function dispLatLng(){
var latlngBounds = map.getBounds();
var swLatlng = latlngBounds.getSouthWest();
var swlat = swLatlng.lat();
var swlng = swLatlng.lng();

var neLatlng = latlngBounds.getNorthEast();
var nelat = neLatlng.lat();
var nelng = neLatlng.lng();

var latlng = map.getCenter();
var cenlat = latlng.lat();
var cenlgn = latlng.lng();
ajaxrequest(null, "get", '/map/list?swlat=' + swlat + '&swlng=' + swlng + '&nelat=' + nelat + '&nelng=' + nelng + '&cenlat=' + cenlat + '&cenlgn=' + cenlgn ,
	function(j_data){
		update_maker(j_data);
	},
	function(j_data){
		alert("aasorry, this system is busy. Please try again later.")
	});
}
function ajaxtesxtrequest(data,type,url,successcb,errorcb){
    $.ajax({
      type: type,
      url: url,
      headers:{'X-CSRF-Token': $('#authenticity_token').val()},
      contentType: 'text/plain',
      dataType: 'json',
      data:data,
      success: function(j_data){
        successcb(j_data);
      },
      error: function(j_data){
          errorcb(j_data);
      }
    });
}
function ajaxrequest(data,type,url,successcb,errorcb){
    $.ajax({
      type: type,
      url: url,
      headers:{'X-CSRF-Token': $('#authenticity_token').val()},
      contentType: 'application/json',
      dataType: 'json',
      data:data,
      success: function(j_data){
        successcb(j_data);
      },
      error: function(j_data){
          errorcb(j_data);
      }
    });
}
function update_maker(json) {
    for(i=0;i<json.length;i++){
    	marker = "";
    	if (json[i]['kind'] > 0 && json[i]['kind'] < 51 ) {
			marker = new google.maps.Marker({
	   		position: new google.maps.LatLng(
	   			json[i]['lat'],
	   			json[i]['lgn']),
	   			map: map,
	   			icon: "/assets/"+ json[i]['kind'] +".png"
	   		});
    	} else {
			marker = new google.maps.Marker({
	   		position: new google.maps.LatLng(
	   			json[i]['lat'],
	   			json[i]['lgn']),
	   			map: map,
	   			icon: "/assets/chihou.png"
	   		});
    	}
    	markers[i] = marker;
	   	onMarkerClick(markers[i], json[i]);
 	}
//	$('#atmlist').html(aaa);
}
var myInfoWindow_open = null;
function onMarkerClick(marker, info){
    google.maps.event.addListener(
        marker
    ,   'click'
    ,   function(event){
    	console.log(info);
    		view_detail(info["mapname"],info['memo'],info['lat'],info['lgn'] ,info['id']);
        }
    );
}
function view_detail(name,memo,lat,lgn,id) {
	document.getElementById("mapid").value = id;
	if (document.getElementById("map_detail").style.display == 'none') {
		document.getElementById("atm_title").innerHTML = name;
		if (memo != "") {
			document.getElementById("atm_memo").innerHTML = memo;
		}
		document.getElementById("atm_memo").innerHTML = 'メモはありません';
		document.getElementById("map_detail").style.display = 'block';
		document.getElementById("atm_comm").innerHTML = 'コメント読み込み中・・・';
		ajaxrequest(null, "get", '/comment/' + id,
		function(j_data){
			if (j_data.length > 0) {
			  	var value = "";
				for (i=0;i<j_data.length;i++) {
		  	    	var user = "";
		  	    	if(j_data[i]["name"] == null ) {
			  	    	user = "匿名";
		  	    	} else {
			  	    	user = j_data[i]["name"];
		  	    	}
		  	    	var ct = formtime(j_data[i]["created_at"]);
			  	    value += "<p class='compart'><b>" + user + '</b>(' + ct + ')　No:' + j_data[i]["id"] +'<br/>' + j_data[i]["value"] + "</p>";
			  	    document.getElementById("atm_comm").innerHTML = value;
				}
			}else{
				document.getElementById("atm_comm").innerHTML = 'コメントはありません';
			}

		},
		function(j_data){
			alert("sorry, this system is busy. Please try again later.")
		});
		ajaxtesxtrequest(null, "get", '/use/' + id,
		function(j_data){
			document.getElementById("use_count").innerHTML = j_data;
		},
		function(j_data){
			alert("sorry, this system is busy. Please try again later.")
		});
		ajaxtesxtrequest(null, "get", '/map/clipcnt/' + id,
		function(j_data){
			document.getElementById("clip_count").innerHTML = j_data;
		},
		function(j_data){
			alert("sorry, this system is busy. Please try again later.")
		});
		ajaxtesxtrequest(null, "get", '/search/' + id,
		function(j_data){
			document.getElementById("search_count").innerHTML = j_data;
		},
		function(j_data){
			alert("sorry, this system is busy. Please try again later.")
		});
	} else {
		document.getElementById("map_detail").style.display = 'none';
	}
}
function formtime (tt) {
	var date = new Date(tt);
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var day = date.getDate();
	var hh = date.getHours();
	var mm = date.getMinutes();
	var ss = date.getSeconds();
	if ( month < 10 ) {
	　　month = '0' + month;
	}
	if ( day < 10 ) {
	　　day = '0' + day;
	}
	return year + '/' + month + '/' + day + " " + hh + ':' + mm + ':' + ss;
}
function route_set(lat, lgn) {
	if($("#self_lat").val() == '' || $("#self_lgn").val() == ''){
		alert("画面上部の「ATMを探す」ボタンを押下するか、現在地ピンを地図に刺してください");
	}
	var From = new google.maps.LatLng($("#self_lat").val(), $("#self_lgn").val());
	directionsService.route({
        origin: From, 
        destination: new google.maps.LatLng(lat,lgn),
        travelMode: google.maps.DirectionsTravelMode.WALKING
    },function(result, status){

    	if (status == google.maps.DirectionsStatus.OK) {
    		directionsDisplay.setMap(map);
      		directionsDisplay.setDirections(result);
      		
      		// editing marker del
      		if (tmpmarker != null ) {
				tmpmarker.setMap(null);
			}
			myInfoWindow.open(null, null);
    	}
    });
}
function clip_set(mapid) {
	var data = $.toJSON({
		id : mapid
	});
	ajaxrequest(data,"post","/map/clip",
	function(j_data){
		endtoast();
	},
	function(j_data){
		if(j_data.status == 401){
		alert("クリップを利用するにはログインしてください");
		} else {
		alert("sorry, this system is busy. Please try again later.")			
		}
	});
}
function map_set(mapid) {
	location.href = "/map/" + mapid;
}
function regist_map() {
	if (document.getElementById("lat").value == ''
		|| document.getElementById("lgn").value == '') {
		alert("配置ボタンから銀行を選択してください。");
		return;
	}

	var data = $.toJSON({
		lat : document.getElementById("lat").value,
		lgn : document.getElementById("lgn").value,
		kind : document.getElementById("kind").value,
		memo : '',
		mapname : '' 
	});
	ajaxrequest(data,"post","/map/create",
	function(j_data){
		dispLatLng();
		if (tmpmarker != null ) {
			tmpmarker.setMap(null);
		}
		registtoast();
	},
	function(j_data){
		alert("sorry, this system is busy. Please try again later.")
	});
}
function select(kind_no) {
	document.getElementById("kind").value = kind_no;
	var latlng = map.getCenter();
	var lat = latlng.lat();
	var lng = latlng.lng();
	if (tmpmarker != null ) {
		tmpmarker.setMap(null);
	}
	if (kind_no > 0 && kind_no< 51 ) {
		tmpmarker = new google.maps.Marker({
			position: new google.maps.LatLng(
				lat,
				lng
			),
			animation: google.maps.Animation.DROP,
			draggable: true,
			map: map,
			icon: "/assets/" + kind_no +".png"
		});
	} else {
		tmpmarker = new google.maps.Marker({
			position: new google.maps.LatLng(
				lat,
				lng
			),
			animation: google.maps.Animation.DROP,
			draggable: true,
			map: map,
			icon: "/assets/chihou.png"
		});		
	}
	var latlng = map.getCenter();
	var lat = latlng.lat();
	var lng = latlng.lng();
	$("#lat").val(lat);
	$("#lgn").val(lng);
	google.maps.event.addListener( tmpmarker, 'dragend', function(ev){
		$("#lat").val(ev.latLng.lat());
		$("#lgn").val(ev.latLng.lng());
		console.log($("#lat").val(),$("#lgn").val());
	});
	$(".kind_close").click();
}
function endtoast() {
$.toast({ 
  heading: '登録しました',
  width: '300px',
  text:'このATMをクリップしました。',
  showHideTransition : 'fade',
  textColor : '#eee',
  allowToastClose : true,
  hideAfter : 3000,
  stack : 1,
  textAlign : 'left',
  icon: 'success',
  position : 'bottom-right'
})
}
function registtoast() {
$.toast({ 
  heading: '登録しました',
  width: '300px',
  text:'このATMを登録しました。',
  showHideTransition : 'fade',
  textColor : '#eee',
  allowToastClose : true,
  hideAfter : 3000,
  stack : 1,
  textAlign : 'left',
  icon: 'success',
  position : 'bottom-right'
})
}
function registuse() {
$.toast({ 
  heading: '登録しました',
  width: '300px',
  text:'このATMを使った！しました。',
  showHideTransition : 'fade',
  textColor : '#eee',
  allowToastClose : true,
  hideAfter : 3000,
  stack : 1,
  textAlign : 'left',
  icon: 'success',
  position : 'bottom-right'
})
}
function changeform_i(){
	document.getElementById("input_form").style.display = 'block';
	document.getElementById("search_form").style.display = 'none';
	document.getElementById("sound-file").play();
}
function changeform_s(){
	document.getElementById("input_form").style.display = 'none';
	document.getElementById("search_form").style.display = 'block';
	document.getElementById("sound-file").play();
}
function where(choice) {
	document.getElementById("where_a").style.display = 'none';
	document.getElementById("where_ka").style.display = 'none';
	document.getElementById("where_sa").style.display = 'none';
	document.getElementById("where_ta").style.display = 'none';
	document.getElementById("where_na").style.display = 'none';
	document.getElementById("where_ha").style.display = 'none';
	document.getElementById("where_ma").style.display = 'none';
	document.getElementById("where_ya").style.display = 'none';
	if(choice == 1) {
		document.getElementById("where_a").style.display = 'block';
	} else if ( choice == 2){
		document.getElementById("where_ka").style.display = 'block';
	} else if ( choice == 3){
		document.getElementById("where_sa").style.display = 'block';
	} else if ( choice == 4){
		document.getElementById("where_ta").style.display = 'block';
	} else if ( choice == 5){
		document.getElementById("where_na").style.display = 'block';
	} else if ( choice == 6){
		document.getElementById("where_ha").style.display = 'block';
	} else if ( choice == 7){
		document.getElementById("where_ma").style.display = 'block';
	} else if ( choice == 8){
		document.getElementById("where_ya").style.display = 'block';
	} else if ( choice == 9){
		document.getElementById("where_ra").style.display = 'block';
	} else if ( choice == 10){
		alert("わ行から始まる銀行は登録できません。")
	}
}
function use_add() {
	var data = $.toJSON({
		id : document.getElementById("mapid").value
	});
	ajaxrequest(data,"post","/use/create",
	function(j_data){
		dispLatLng();
		if (tmpmarker != null ) {
			tmpmarker.setMap(null);
		}
		registuse();
	},
	function(j_data){
		alert("sorry, this system is busy. Please try again later.")
	});
}
</script>
