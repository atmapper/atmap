<div class="top_map_middle">

<div id="top_map_buttom">
	<b style="font-size:16px;"><%= @mapname %></b>(<%= @create.strftime("%Y/%m/%d %H:%M")  %>)
	<script src="https://maps.googleapis.com/maps/api/js?&sensor=false"></script>
	<div id="map-canvas" style="width:100%;height:250px;"></div>
<br/><b>コメントを投稿する</b><br/>
	<div class="input-group">
		<input type="text" name="comment" id="cominner" class="form-control" placeholder="255文字まで入力できます">
		<span class="input-group-btn">
			<button type="button" class="btn btn-primary" onclick="comsubmit();">コメント投稿</button>
		</span>
	</div>
	<br/>
	<span id="comcnt">コメント読み込み中・・・</span>
<div id="comlist" style="margin:5px 0 0 0;">
</div>
</div>
<input type="hidden" id="mapid" value="<%= @id %>" />
<script type="text/javascript">
var before_title ="";
//キャンパスの要素を取得する
var canvas = document.getElementById( "map-canvas" );
var crossSize = 19;
//中心の位置座標を指定する
var latlng = new google.maps.LatLng( <%= @lat %> , <%= @lgn %> );
var map;

//地図のオプションを設定する
var mapOptions = {
	zoom: 14 ,
	center: latlng,
	scrollwheel: false,
	mapTypeControlOptions: { mapTypeIds: ['sample', google.maps.MapTypeId.ROADMAP] }
};
	map = new google.maps.Map( canvas , mapOptions );
	markers = new google.maps.Marker({
	position: new google.maps.LatLng(
		<%= @lat %>,
		<%= @lgn %>),
		map: map,
		icon: "/assets/<%= @kind %>.png"
	});
// マーカー情報取得
$.ajax({
  type: 'get',
  url: '/comment/<%= @id %>' ,
  headers:{'X-CSRF-Token': $('#authenticity_token').val()},
  contentType: 'application/json',
  dataType: 'json',
  data:null,
  success: function(json){
  	comlistout(json);
  },error: function(json){
    alert("コメントの読み込みに失敗しました")
  }
});
function comlistout(json) {
  	var value = "";
  		if (json.length > 0) {
  			$('#comcnt').html('コメント数：' + json.length + '<br/>');
  		} else {
  			$('#comcnt').html('コメントはありません<br/>');
  		}
  	    for(i=0;i<json.length;i++){
  	    	var user = "";
  	    	console.log(json[i]);
  	    	if(json[i]["name"] == null ) {
	  	    	user = "匿名";
  	    	} else {
	  	    	user = json[i]["name"];
  	    	}
  	    	var ct = formtime(json[i]["created_at"]);
	  	    value += "<p class='compart'><b>" + user + '</b>(' + ct + ')　No:' + json[i]["id"] +'<br/>' + json[i]["value"] + "</p>";
	 	}
	 	$('#comlist').html(value);
}
function formtime (tt) {
	var date = new Date(tt);
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var day = date.getDate();
	var hh = date.getHours();
	var mm = date.getMinutes();
	var ss = date.getSeconds();
	if ( month < 10 ) {
	　　month = '0' + month;
	}
	if ( day < 10 ) {
	　　day = '0' + day;
	}
	return year + '/' + month + '/' + day + " " + hh + ':' + mm + ':' + ss;
}
function ajaxrequest(data,type,url,successcb,errorcb){
    $.ajax({
      type: type,
      url: url,
      headers:{'X-CSRF-Token': $('#authenticity_token').val()},
      contentType: 'application/json',
      dataType: 'json',
      data:data,
      success: function(j_data){
        successcb(j_data);
      },
      error: function(j_data){
          errorcb(j_data);
      }
    });
}
function comsubmit() {
	var data = $.toJSON({
		value : document.getElementById("cominner").value,
		mapid : document.getElementById("mapid").value
	});
	ajaxrequest(data,"post","/comment/create",
		function(json){
			comlistout(json);
			document.getElementById("cominner").value　= '';
		},
		function(json){
			alert("sorry, this system is busy. Please try again later.")
		});
}
</script>